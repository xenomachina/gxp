// Copyright 2006 Google Inc. All Rights Reserved.

package com.google.gxp.compiler.fs;

import com.google.common.base.Charsets;
import com.google.common.io.Characters;

import junit.framework.TestCase;

import java.util.*;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.Reader;
import java.io.Writer;

import com.google.testing.util.MoreAsserts;

/**
 * Tests of {@link InMemoryFileSystem}.
 */
public class InMemoryFileSystemTest extends TestCase {

  private final InMemoryFileSystem fs = new InMemoryFileSystem();

  private void assertContentsEqualTo(FileRef fnam, String expected) throws Exception {
    Reader in = fnam.openReader(Charsets.US_ASCII);
    assertEquals(expected, Characters.toString(in));
    in.close();
  }

  private void assertCantOpenReader(FileRef fnam) {
    try {
      fnam.openReader(Charsets.US_ASCII);
      fail("should throw exception");
    } catch (IOException e) {
      // expected
    }
  }

  private void assertCantOpenWriter(FileRef fnam) {
    try {
      fnam.openWriter(Charsets.US_ASCII);
      fail("should throw exception");
    } catch (IOException e) {
      // expected
    }
  }

  public void testGetRoot() throws Exception {
    assertEquals("/", fs.getRoot().getName());
  }

  public void testGetLastModified() throws Exception {
    // nonexistant file
    FileRef file = fs.parseFilename("/foo/bar/baz.txt");
    assertEquals(0, file.getLastModified());

    // create file without setting time
    file.openOutputStream().close();
    assertEquals(0, file.getLastModified());

    // create file after setting time to a positive value
    fs.setCurrentTime(12345);
    file.openOutputStream().close();
    assertEquals(12345, file.getLastModified());

    // create file after setting time to a non-positive value
    fs.setCurrentTime(0);
    file.openOutputStream().close();
    assertEquals(0, file.getLastModified());
  }

  public void testOpenInputStream_nonexistant() throws Exception {
    FileRef hello = fs.parseFilename("/foo/bar/baz");
    try {
      hello.openInputStream();
      fail("Was able to open nonexistant file.");
    } catch (FileNotFoundException fnfx) {
      // yay!
    }
  }

  public void testOpenInputStreamAndOpenWriter() throws Exception {
    FileRef hello = fs.parseFilename("/foo/bar/baz");
    FileRef goodbye = fs.parseFilename("/snarf/quux");

    // Write a couple of files, and make sure we can read them back.
    // Two files used to ensure the file system keeps them separate.
    String helloText = "hello, world!";
    String goodbyeText = "goodbye, world!";

    Writer out = hello.openWriter(Charsets.US_ASCII);
    out.write(helloText);
    out.close();
    out = goodbye.openWriter(Charsets.US_ASCII);
    out.write(goodbyeText);
    out.close();

    // Re-create filenames, just to make sure we aren't relying on object
    // identity.
    hello = fs.parseFilename("/foo/bar/baz");
    goodbye = fs.parseFilename("/snarf/quux");

    assertContentsEqualTo(hello, helloText);
    assertContentsEqualTo(goodbye, goodbyeText);
  }

  public void testOpenWriter_overwriteExistingFile() throws Exception {
    FileRef fnam = fs.parseFilename("/foo/bar/baz");

    String oldText = "that was then";
    Writer out = fnam.openWriter(Charsets.US_ASCII);
    out.write(oldText);
    out.close();

    assertContentsEqualTo(fnam, oldText);

    String newText = "this is now";
    out = fnam.openWriter(Charsets.US_ASCII);
    out.write(newText);
    out.close();

    assertContentsEqualTo(fnam, newText);
  }

  public void testOpenReader_whiteAlreadyOpen() throws Exception {
    FileRef fnam = fs.parseFilename("/foo/bar/baz");
    fnam.openWriter(Charsets.US_ASCII).close();

    Writer out = fnam.openWriter(Charsets.US_ASCII);
    assertCantOpenReader(fnam);

    out.close();
    Reader in = fnam.openReader(Charsets.US_ASCII);
    in.close();
  }

  public void testOpenWriter_whileAlreadyOpen() throws Exception {
    FileRef fnam = fs.parseFilename("/foo/bar/baz");
    fnam.openWriter(Charsets.US_ASCII).close();

    // open for reading
    Reader in = fnam.openReader(Charsets.US_ASCII);

    // open for writing should fail
    assertCantOpenWriter(fnam);

    // open for reading again
    Reader in2 = fnam.openReader(Charsets.US_ASCII);
    in.close();

    // open for writing should fail
    assertCantOpenWriter(fnam);

    in2.close();

    // Opening 2 writers at the same time is not allowed
    Writer out = fnam.openWriter(Charsets.US_ASCII);
    assertCantOpenWriter(fnam);
  }

  public void testToFilename() throws Exception {
    assertEquals("/foo/bar/baz",
                 fs.parseFilename("foo/bar/baz").toFilename());
  }

  public void testParseFilename() throws Exception {
    assertEquals(fs.parseFilename("/foo/bar/baz"),
                 fs.parseFilename("foo/bar/baz"));
  }

  public void assertFilenameCorrect(FileSystem fs, String s)
      throws Exception {
    // check both directions:
    assertEquals(fs.parseFilename(s), fs.parseFilename(s));
    assertEquals(fs.parseFilename(s).getName(),
                 fs.parseFilename(s).toFilename());
  }

  public void testFilenamesSameAsFilenameValues() throws Exception {
    assertFilenameCorrect(fs, "foo/bar/baz");
    assertFilenameCorrect(fs, "/foo/bar/baz");
    assertFilenameCorrect(fs, "/foo/bar/baz/");
    assertFilenameCorrect(fs, "foo/bar/baz/");
    assertFilenameCorrect(fs, "foo//bar/baz");
    assertFilenameCorrect(fs, "/foo/bar//baz");
    assertFilenameCorrect(fs, "/foo/bar//baz/");
    assertFilenameCorrect(fs, "foo//bar/baz/");
    assertFilenameCorrect(fs, "///foo////bar/////baz//////");
  }

  public void testParseFilenameList() throws Exception {
    MoreAsserts.assertContentsInOrder(
        fs.parseFilenameList("foo/bar/baz:zork/zelda/zaxxon"),
        fs.parseFilename("foo/bar/baz"),
        fs.parseFilename("zork/zelda/zaxxon"));
  }

  public void testGetManifest() throws Exception {
    // 0 files
    assertTrue(fs.getManifest().isEmpty());

    // 1 file
    fs.parseFilename("/foo/bar").openWriter(Charsets.US_ASCII).close();
    MoreAsserts.assertContentsAnyOrder(fs.getManifest(),
                                       fs.parseFilename("/foo/bar"));

    // 2 files
    fs.parseFilename("/foo/baz").openWriter(Charsets.US_ASCII).close();
    MoreAsserts.assertContentsAnyOrder(fs.getManifest(),
                                       fs.parseFilename("/foo/bar"),
                                       fs.parseFilename("/foo/baz"));

    // overwrote existing file
    fs.parseFilename("/foo/baz").openWriter(Charsets.US_ASCII).close();
    MoreAsserts.assertContentsAnyOrder(fs.getManifest(),
                                       fs.parseFilename("/foo/bar"),
                                       fs.parseFilename("/foo/baz"));

    // while file is open for read
    Reader in = fs.parseFilename("/foo/bar").openReader(Charsets.US_ASCII);
    try {
      fs.getManifest();
      fail("should fail when file is open");
    } catch (IOException e) {
      // expected
    }
    in.close();

    // while file is open for write
    Writer out = fs.parseFilename("/foo/bar").openWriter(Charsets.US_ASCII);
    try {
      fs.getManifest();
      fail("should fail when file is open");
    } catch (IOException e) {
      // expected
    }
    in.close();
  }

  public void testDelete() throws Exception {
    FileRef file = fs.parseFilename("/foo");

    // create file
    file.openWriter(Charsets.US_ASCII).close();

    // test read
    Reader r = file.openReader(Charsets.US_ASCII);
    r.close();

    // delete file
    assertTrue(file.delete());

    // verify it doesn't exit anymore
    try {
      r = file.openReader(Charsets.US_ASCII);
      fail("file should not exist anymore.");
    } catch (FileNotFoundException e) {
      // success!
    }
  }
}
